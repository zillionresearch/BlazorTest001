name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: [self-hosted, windows, vps, production]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore "Website/Version002/MoneyWorkdesk/MoneyWorkdesk.csproj"

    - name: Build application
      run: dotnet build "Website/Version002/MoneyWorkdesk/MoneyWorkdesk.csproj" --configuration Release --no-restore

    - name: Publish application
      run: dotnet publish "Website/Version002/MoneyWorkdesk/MoneyWorkdesk.csproj" --configuration Release --no-build --output ./publish

    - name: Stop IIS App Pool
      run: |
        Import-Module WebAdministration
        Stop-WebAppPool -Name "BlazorTest001"
        Start-Sleep -Seconds 5
      shell: pwsh

    - name: Deploy to IIS
      run: |
        $destination = "C:\Websites1\BlazorTest001"

        # Remove old files (keep web.config if exists)
        if (Test-Path $destination) {
          Get-ChildItem -Path $destination -Exclude "web.config" | Remove-Item -Recurse -Force
        }

        # Copy new files
        Copy-Item -Path "./publish/*" -Destination $destination -Recurse -Force

        Write-Host "Deployment complete to $destination"
      shell: pwsh

    - name: Start IIS App Pool
      run: |
        Import-Module WebAdministration
        Start-WebAppPool -Name "BlazorTest001"
        Start-Sleep -Seconds 3

        # Verify app pool is running
        $appPool = Get-WebAppPoolState -Name "BlazorTest001"
        Write-Host "App Pool Status: $($appPool.Value)"
      shell: pwsh

    - name: Verify deployment
      run: |
        Write-Host "=== Deployment Summary ===" -ForegroundColor Cyan
        Write-Host "Deployed to: C:\Websites1\BlazorTest001" -ForegroundColor Green
        Write-Host "Website URL: http://test.moneyworkdesk.com" -ForegroundColor Green
        Write-Host "App Pool: BlazorTest001" -ForegroundColor Green
        Write-Host ""
        Write-Host "Verify site is running:" -ForegroundColor Yellow
        Write-Host "  curl http://test.moneyworkdesk.com" -ForegroundColor Gray
      shell: pwsh
